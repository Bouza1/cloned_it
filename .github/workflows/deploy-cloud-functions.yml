name: Deploy Cloud Functions

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment name (dev/prod)'
        required: true
        type: string
    secrets:
      project_id:
        description: 'Google Cloud Project ID'
        required: true
      gcp_sa_key:
        description: 'Google Cloud Service Account Key'
        required: true

jobs:
  deploy_functions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.gcp_sa_key }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Enable required GCP APIs
        run: |
          gcloud services enable \
            cloudfunctions.googleapis.com \
            run.googleapis.com \
            cloudbuild.googleapis.com \
            artifactregistry.googleapis.com \
            eventarc.googleapis.com \
            pubsub.googleapis.com \
            --project "${{ secrets.project_id }}"

      - name: Create Pub/Sub topics
        run: |
          # Create cleanup-sessions-topic if it doesn't exist
          if ! gcloud pubsub topics describe cleanup-sessions-topic --project "${{ secrets.project_id }}" &>/dev/null; then
            gcloud pubsub topics create cleanup-sessions-topic \
              --project "${{ secrets.project_id }}"
            echo "Created topic: cleanup-sessions-topic"
          else
            echo "Topic cleanup-sessions-topic already exists"
          fi

      - name: Deploy HTTP functions
        run: |
          for func in get_posts get_sessions_overview create_session validate_session delete_session get_user_session; do
            cp -r functions/shared functions/$func/shared
            gcloud functions deploy $func \
              --gen2 \
              --runtime python311 \
              --trigger-http \
              --region europe-west1 \
              --project "${{ secrets.project_id }}" \
              --entry-point $func \
              --source functions/$func \
              --set-env-vars CLOUD_SQL_CONNECTION_NAME="${{ secrets.project_id }}:europe-west1:cloned-it-dev",DB_USER=root,DB_NAME=cloned_it,GCP_PROJECT="${{ secrets.project_id }}" \
              --no-allow-unauthenticated \
              --quiet
          done

      - name: Deploy cleanup_old_sessions
        run: |
          cp -r functions/shared functions/cleanup_old_sessions/shared
          gcloud functions deploy cleanup_old_sessions \
            --gen2 \
            --runtime python311 \
            --trigger-topic cleanup-sessions-topic \
            --region europe-west1 \
            --project "${{ secrets.project_id }}" \
            --entry-point cleanup_old_sessions \
            --source functions/cleanup_old_sessions \
            --set-env-vars GCP_PROJECT="${{ secrets.project_id }}" \
            --quiet

      - name: Grant App Engine permissions to invoke HTTP functions
        run: |
          for service in get-posts get-sessions-overview create-session validate-session delete-session get-user-session; do
            gcloud run services add-iam-policy-binding $service \
              --region=europe-west1 \
              --member="serviceAccount:${{ secrets.project_id }}@appspot.gserviceaccount.com" \
              --role="roles/run.invoker" \
              --project="${{ secrets.project_id }}"
          done

      - name: Deployment Summary
        run: |
          echo "Successfully deployed Cloud Functions to ${{ inputs.environment }} environment"
          echo "Project: ${{ secrets.project_id }}"
          echo "Functions deployed:"
          echo "  - get_posts (HTTP)"
          echo "  - get_sessions_overview (HTTP)"
          echo "  - create_session (HTTP)"
          echo "  - validate_session (HTTP)"
          echo "  - delete_session (HTTP)"
          echo "  - get_user_session (HTTP)"
          echo "  - cleanup_old_sessions (Pub/Sub)"

