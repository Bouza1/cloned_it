name: Deploy Application

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment name (dev/prod)'
        required: true
        type: string
      app_yaml:
        description: 'App Engine YAML file to deploy'
        required: true
        type: string
    secrets:
      project_id:
        description: 'Google Cloud Project ID'
        required: true
      gcp_sa_key:
        description: 'Google Cloud Service Account Key'
        required: true

jobs:
  deploy_app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Install pipx
        run: sudo apt install pipx
      
      - name: Ensure pipx is on PATH
        run: pipx ensurepath

      - name: Install Poetry using pipx
        run: pipx install poetry==1.8

      - name: Generate requirements.txt from Poetry
        run: poetry export -f requirements.txt --output requirements.txt --without-hashes

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.gcp_sa_key }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Datastore Indexes
        run: |
          if [ -f index.yaml ]; then
            echo "Deploying Datastore indexes..."
            gcloud datastore indexes create index.yaml \
              --project "${{ secrets.project_id }}" \
              --quiet
          else
            echo "No index.yaml found, skipping index deployment"
          fi

      - name: Deploy to App Engine
        run: |
          gcloud app deploy ${{ inputs.app_yaml }} \
            --project "${{ secrets.project_id }}" \
            --quiet

      - name: Deployment Summary
        run: |
          echo "Successfully deployed application to ${{ inputs.environment }} environment"
          echo "Project: ${{ secrets.project_id }}"
          echo "App YAML: ${{ inputs.app_yaml }}"

