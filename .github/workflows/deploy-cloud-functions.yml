name: Deploy Cloud Functions

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment name (dev/prod)'
        required: true
        type: string
    secrets:
      project_id:
        description: 'Google Cloud Project ID'
        required: true
      gcp_sa_key:
        description: 'Google Cloud Service Account Key'
        required: true

jobs:
  deploy_functions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.gcp_sa_key }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Enable required GCP APIs
        run: |
          gcloud services enable cloudfunctions.googleapis.com \
            --project "${{ secrets.project_id }}"
          gcloud services enable run.googleapis.com \
            --project "${{ secrets.project_id }}"
          gcloud services enable cloudbuild.googleapis.com \
            --project "${{ secrets.project_id }}"
          gcloud services enable artifactregistry.googleapis.com \
            --project "${{ secrets.project_id }}"
          gcloud services enable eventarc.googleapis.com \
            --project "${{ secrets.project_id }}"
          gcloud services enable pubsub.googleapis.com \
            --project "${{ secrets.project_id }}"

      - name: Create Pub/Sub topics
        run: |
          # Create cleanup-sessions-topic if it doesn't exist
          if ! gcloud pubsub topics describe cleanup-sessions-topic --project "${{ secrets.project_id }}" &>/dev/null; then
            gcloud pubsub topics create cleanup-sessions-topic \
              --project "${{ secrets.project_id }}"
            echo "Created topic: cleanup-sessions-topic"
          else
            echo "Topic cleanup-sessions-topic already exists"
          fi

      - name: Deploy get_datastore_stats
        run: |
          gcloud functions deploy get_datastore_stats \
            --gen2 \
            --runtime python311 \
            --trigger-http \
            --region europe-west1 \
            --project "${{ secrets.project_id }}" \
            --entry-point get_datastore_stats \
            --source functions/get_datastore_stats \
            --no-allow-unauthenticated \
            --quiet
      
      - name: Grant App Engine permission to invoke get_datastore_stats
        run: |
          gcloud run services add-iam-policy-binding get-datastore-stats \
            --region=europe-west1 \
            --member="serviceAccount:${{ secrets.project_id }}@appspot.gserviceaccount.com" \
            --role="roles/run.invoker" \
            --project="${{ secrets.project_id }}"

      - name: Deploy cleanup_old_sessions
        run: |
          gcloud functions deploy cleanup_old_sessions \
            --gen2 \
            --runtime python311 \
            --trigger-topic cleanup-sessions-topic \
            --region europe-west1 \
            --project "${{ secrets.project_id }}" \
            --entry-point cleanup_old_sessions \
            --source functions/cleanup_old_sessions \
            --quiet

      - name: Deploy get_mysql_stats
        run: |
          cp -r functions/shared functions/get_mysql_stats/shared
          gcloud functions deploy get_mysql_stats \
            --gen2 \
            --runtime python311 \
            --trigger-http \
            --region europe-west1 \
            --project "${{ secrets.project_id }}" \
            --entry-point get_mysql_stats \
            --source functions/get_mysql_stats \
            --no-allow-unauthenticated \
            --set-env-vars CLOUD_SQL_CONNECTION_NAME="${{ secrets.project_id }}:europe-west1:cloned-it-db",DB_USER=root,DB_NAME=cloned_it,GCP_PROJECT="${{ secrets.project_id }}" \
            --quiet
      
      - name: Grant App Engine permission to invoke get_mysql_stats
        run: |
          gcloud run services add-iam-policy-binding get-mysql-stats \
            --region=europe-west1 \
            --member="serviceAccount:${{ secrets.project_id }}@appspot.gserviceaccount.com" \
            --role="roles/run.invoker" \
            --project="${{ secrets.project_id }}"

      - name: Deployment Summary
        run: |
          echo "Successfully deployed Cloud Functions to ${{ inputs.environment }} environment"
          echo "Project: ${{ secrets.project_id }}"
          echo "Functions deployed:"
          echo "  - get_datastore_stats"
          echo "  - cleanup_old_sessions"
          echo "  - get_mysql_stats"

